<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Checkout</h4>
          
          <!-- Progress Steps -->
          
        </div>

        <div class="card-body">
          <form [formGroup]="checkoutForm">
            <!-- Step 1: Address -->
            <div *ngIf="currentStep === 1">
              <h5 class="mb-3">Shipping Address</h5>
              
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="street" class="form-label">Street Address</label>
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="f['street'].invalid && f['street'].touched"
                         id="street" 
                         formControlName="street"
                         placeholder="Enter your street address">
                  <div class="invalid-feedback" *ngIf="f['street'].invalid && f['street'].touched">
                    Street address is required
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="city" class="form-label">City</label>
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="f['city'].invalid && f['city'].touched"
                         id="city" 
                         formControlName="city"
                         placeholder="Enter city">
                  <div class="invalid-feedback" *ngIf="f['city'].invalid && f['city'].touched">
                    City is required
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="state" class="form-label">State</label>
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="f['state'].invalid && f['state'].touched"
                         id="state" 
                         formControlName="state"
                         placeholder="Enter state">
                  <div class="invalid-feedback" *ngIf="f['state'].invalid && f['state'].touched">
                    State is required
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="postalCode" class="form-label">Postal Code</label>
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="f['postalCode'].invalid && f['postalCode'].touched"
                         id="postalCode" 
                         formControlName="postalCode"
                         placeholder="Enter postal code">
                  <div class="invalid-feedback" *ngIf="f['postalCode'].invalid && f['postalCode'].touched">
                    <div *ngIf="f['postalCode'].errors?.['required']">Postal code is required</div>
                    <div *ngIf="f['postalCode'].errors?.['pattern']">Please enter a valid postal code</div>
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="country" class="form-label">Country</label>
                  <input type="text" 
                         class="form-control" 
                         id="country" 
                         formControlName="country"
                         readonly>
                </div>
              </div>
            </div>

            <!-- Step 2: Payment -->
            <div *ngIf="currentStep === 2">
              <h5 class="mb-3">Payment Method</h5>
              
              <div class="payment-methods">
                <div class="payment-method" 
                     *ngFor="let method of paymentMethods"
                     [class.selected]="f['paymentMethod'].value === method.id">
                  <input type="radio" 
                         [id]="method.id" 
                         [value]="method.id" 
                         formControlName="paymentMethod"
                         class="form-check-input">
                  <label [for]="method.id" class="form-check-label">
                    <span class="payment-icon">{{ method.icon }}</span>
                    {{ method.name }}
                  </label>
                </div>
              </div>

              <!-- Card Details -->
              <div *ngIf="f['paymentMethod'].value === 'credit_card' || f['paymentMethod'].value === 'debit_card'" 
                   class="mt-4">
                <h6>Card Details</h6>
                <div class="row">
                  <div class="col-12 mb-3">
                    <label for="cardNumber" class="form-label">Card Number</label>
                    <input type="text" 
                           class="form-control" 
                           [class.is-invalid]="f['cardNumber'].invalid && f['cardNumber'].touched"
                           id="cardNumber" 
                           formControlName="cardNumber"
                           placeholder="1234 5678 9012 3456"
                           maxlength="16">
                    <div class="invalid-feedback" *ngIf="f['cardNumber'].invalid && f['cardNumber'].touched">
                      Please enter a valid card number
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="cardExpiry" class="form-label">Expiry Date</label>
                    <input type="text" 
                           class="form-control" 
                           [class.is-invalid]="f['cardExpiry'].invalid && f['cardExpiry'].touched"
                           id="cardExpiry" 
                           formControlName="cardExpiry"
                           placeholder="MM/YY"
                           maxlength="5">
                    <div class="invalid-feedback" *ngIf="f['cardExpiry'].invalid && f['cardExpiry'].touched">
                      Please enter a valid expiry date
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="cardCvv" class="form-label">CVV</label>
                    <input type="password" 
                           class="form-control" 
                           [class.is-invalid]="f['cardCvv'].invalid && f['cardCvv'].touched"
                           id="cardCvv" 
                           formControlName="cardCvv"
                           placeholder="123"
                           maxlength="4">
                    <div class="invalid-feedback" *ngIf="f['cardCvv'].invalid && f['cardCvv'].touched">
                      Please enter CVV
                    </div>
                  </div>
                  
                  <div class="col-12 mb-3">
                    <label for="cardName" class="form-label">Cardholder Name</label>
                    <input type="text" 
                           class="form-control" 
                           [class.is-invalid]="f['cardName'].invalid && f['cardName'].touched"
                           id="cardName" 
                           formControlName="cardName"
                           placeholder="Enter name on card">
                    <div class="invalid-feedback" *ngIf="f['cardName'].invalid && f['cardName'].touched">
                      Cardholder name is required
                    </div>
                  </div>
                </div>
              </div>

              <!-- UPI Details -->
              <div *ngIf="f['paymentMethod'].value === 'upi'" class="mt-4">
                <h6>UPI Details</h6>
                <div class="mb-3">
                  <label for="upiId" class="form-label">UPI ID</label>
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="f['upiId'].invalid && f['upiId'].touched"
                         id="upiId" 
                         formControlName="upiId"
                         placeholder="yourname@upi">
                  <div class="invalid-feedback" *ngIf="f['upiId'].invalid && f['upiId'].touched">
                    Please enter a valid UPI ID
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Review -->
            <div *ngIf="currentStep === 3">
              <h5 class="mb-3">Review Order</h5>
              
              <!-- Address Review -->
              <div class="mb-4">
                <h6>Shipping Address</h6>
                <div class="bg-light p-3 rounded">
                  <p class="mb-1">{{ f['street'].value }}</p>
                  <p class="mb-0">{{ f['city'].value }}, {{ f['state'].value }} {{ f['postalCode'].value }}</p>
                  <p class="mb-0">{{ f['country'].value }}</p>
                </div>
              </div>

              <!-- Payment Review -->
              <div class="mb-4">
                <h6>Payment Method</h6>
                <div class="bg-light p-3 rounded">
                  <p class="mb-0">
                    {{ getPaymentMethodName(f['paymentMethod'].value) }}
                    <span *ngIf="f['paymentMethod'].value === 'credit_card' || f['paymentMethod'].value === 'debit_card'">
                      ending in {{ f['cardNumber'].value?.slice(-4) }}
                    </span>
                  </p>
                </div>
              </div>

              <!-- Items Review -->
              <div class="mb-4">
                <h6>Order Items</h6>
                <div class="bg-light p-3 rounded">
                  <div *ngFor="let item of cartItems" class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <span class="fw-medium">{{ item.product.name }}</span>
                      <span class="text-muted"> × {{ item.quantity }}</span>
                    </div>
                    <span>₹{{ (item.price * item.quantity) | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-between mt-4">
            <button type="button" 
                    class="btn btn-outline-secondary"
                    *ngIf="currentStep > 1"
                    (click)="previousStep()">
              Previous
            </button>
            
            <div class="ms-auto">
              <button type="button" 
                      class="btn btn-primary"
                      *ngIf="currentStep < 3"
                      (click)="nextStep()">
                Next
              </button>
              
              <button type="button" 
                      class="btn btn-success"
                      *ngIf="currentStep === 3"
                      [disabled]="checkoutForm.invalid || isLoading"
                      (click)="placeOrder()">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                {{ isLoading ? 'Placing Order...' : 'Place Order' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal ({{ cartSummary.itemCount }} items)</span>
            <span>₹{{ cartSummary.subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Tax</span>
            <span>₹{{ cartSummary.tax | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span>Shipping</span>
            <span *ngIf="cartSummary.shipping === 0" class="text-success">Free</span>
            <span *ngIf="cartSummary.shipping > 0">₹{{ cartSummary.shipping | number:'1.2-2' }}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong class="text-primary">₹{{ cartSummary.total | number:'1.2-2' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>